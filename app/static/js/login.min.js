$(document).ready(function () {
    var email = new RegExp(/^([a-zA-Z0-9_.+-])+\@(([a-zA-Z0-9-])+\.)+([a-zA-Z0-9]{2,4})+$/);

    $("#cargando").fadeOut("slow");
$("#btn-entrar").click(function () {
    if ($("#correo").val() === "") {
        error_formulario("correo", "El correo es requerido");
        return false;
    } else if (!email.test($("#correo").val())) {
        error_formulario("correo", "El formato del correo es usuario@servidor.algo");
        return false;
    } else if ($("#contra").val() === "") {
        error_formulario("contra", "La contraseña es requerida");
        return false;
    }

    $.ajax({
        url: appData.uri_ws + "backendL/acceso",
        type: "post",
        dataType: "json",
        data: {
            correo: $("#correo").val(),
            contra: $("#contra").val()
        }
    })
    .done(function (json) {
        if (json.resultado) {
            var tipoUsuario = json.usuario.tipo;
            var id = json.usuario.id;
            var url;
            muestra_mensaje("success", json.mensaje);

            // Mostrar el tipo de usuario y el ID en la consola
            console.log("Tipo de usuario: " + tipoUsuario);
            console.log("ID de usuario: " + id);

            // Guardar información de sesión en localStorage
            var sessionData = {
                tipoUsuario: tipoUsuario,
                id: id
            };
            localStorage.setItem("sessionData", JSON.stringify(sessionData));

            if (tipoUsuario == 2) {
                url = appData.uri_app + "maestros/";
            } else if (tipoUsuario == 3) {
                url = appData.uri_app + "alumnos/";
            } else if (tipoUsuario == 1) {
                url = appData.uri_app + "clases/";
            } else {
                url = appData.uri_app + "login";
            }

            window.location.href = url;
        } else {
            muestra_mensaje("danger", json.mensaje);
        }
    })
    .fail(alert_error);
});   


 function resetRegistroForm() {
        $("#modal-nombre, #modal-apellidos, #modal-correo, #modal-contra").val("");
        $(".is-invalid").removeClass("is-invalid");
        $(".invalid-feedback").remove();
    }

    function registerUser() {
        var modalNombre = $("#modal-nombre").val();
        var modalApellidos = $("#modal-apellidos").val();
        var modalContra = $("#modal-contra").val();
        var modalCorreo = $("#modal-correo").val();
        var modalDireccion = $("#modal-direccion").val();
        var modalTelefono = $("#modal-telefono").val();

        if (modalNombre === "") {
            error_formulario("modal-nombre", "El nombre es requerido");
            return false;
        } else if (modalApellidos === "") {
            error_formulario("modal-apellidos", "Los apellidos son requeridos");
            return false;
        } else if (modalContra === "") {
            error_formulario("modal-contra", "La contraseña es requerida");
            return false;
        } else if (modalCorreo === "" || !email.test(modalCorreo)) {
            error_formulario("modal-correo", "Ingrese un correo válido");
            return false;
        }

        $.ajax({
            url: appData.uri_ws + "backendL/registrausuario",
            type: "post",
            dataType: "json",
            data: {
                nombre: modalNombre,
                apellidos: modalApellidos,
                correo: modalCorreo,
                contra: modalContra,
                direccion: modalDireccion,
                telefono: modalTelefono
            }
        })
        .done(function (json) {
            if (json.resultado) {
                $("#correo").val(modalCorreo).focus();
                muestra_mensaje("success", json.mensaje);

                $.ajax({
                    type: "POST",
                    url: "https://emblematic-yolk.000webhostapp.com/envio/envioGmail.php",
                   data: {
    correo: modalCorreo,
    token: "2023_" + json.id
},
                    success: function (response) {
                        console.log("Correo electrónico enviado exitosamente");
                    },
                    error: function (xhr, status, error) {
                        console.error("Error al enviar el correo electrónico:", error);
                    }
                });
            } else {
                muestra_mensaje("danger", json.mensaje);
            }
        })
        .fail(alert_error);
    }

    function validateToken() {
        var token = $('#token').val();
        var grupo = $('#grupo').val();

        $.ajax({
            url: appData.uri_ws + "backendL/cambiar_grupo_y_validar_token",
            type: "post",
            dataType: "json",
            data: {
                token: token,
                grupo: grupo
            }
        })
        .done(function (json) {
            if (json.resultado) {
		muestra_mensaje("success", json.mensaje);
                console.log(`Token válido para el grupo: ${grupo}`);
            } else {
                console.log("Token no válido");
            }
        })
        .fail(function (xhr, status, error) {
            console.error("Error en la petición AJAX:", error);
		muestra_mensaje("success", "El usuario fue validado");
        });
    }

    $("#btn-register-user").click(function (e) {
        e.preventDefault();
        registerUser();
    });

    $('#btn-validar-token').click(function () {
        validateToken();
    });

    $("#btn-registrar").click(function () {
        resetRegistroForm();
    });

   function muestra_mensaje(tipo, mensaje) {
    $(".alert").remove();

    var alertElement = `<div class="alert alert-${tipo} alert-dismissible fade show" role="alert" style="position:absolute;bottom:20px;right:20px;">
        <strong>${tipo.charAt(0).toUpperCase() + tipo.slice(1)}!</strong> ${mensaje}.
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>`;

    $("#mensaje").append(alertElement);

    // Cerrar la alerta después de 5 segundos
    setTimeout(function() {
        $(".alert").alert('close');
    }, 3000);
}
    function error_formulario(id_elemento, mensaje) {
        $("#" + id_elemento).addClass("is-invalid");
        $("#" + id_elemento).after(`<div class="invalid-feedback">${mensaje}</div>`);
    }

    function alert_error(xhr, status, error) {
        console.error("Error en la petición AJAX:", error);
    }
});